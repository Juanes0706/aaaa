<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actualizar Categoría - Inventario y Ventas API</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <nav class="navbar">
        <a href="/">Inicio</a>
        
        <div class="dropdown">
            <button class="dropbtn">Categorías</button>
            <div class="dropdown-content">
                <a href="/categorias">Ver Categorías</a>
                <a href="/categorias/create">Crear Categoría</a>
                <a href="/categorias/update">Actualizar Categoría</a>
                <a href="/categorias/delete">Eliminar Categoría</a>
            </div>
        </div>
        
        <div class="dropdown">
            <button class="dropbtn">Productos</button>
            <div class="dropdown-content">
                <a href="/productos">Ver Productos</a>
                <a href="/productos/create">Crear Producto</a>
                <a href="/productos/update">Actualizar Producto</a>
                <a href="/productos/delete">Eliminar Producto</a>
            </div>
        </div>
        
        <div class="dropdown">
            <button class="dropbtn">Clientes</button>
            <div class="dropdown-content">
                <a href="/clientes">Ver Clientes</a>
                <a href="/clientes/create">Crear Cliente</a>
                <a href="/clientes/update">Actualizar Cliente</a>
                <a href="/clientes/delete">Eliminar Cliente</a>
            </div>
        </div>
        
        <div class="dropdown">
            <button class="dropbtn">Ventas</button>
            <div class="dropdown-content">
                <a href="/ventas">Ver Ventas</a>
                <a href="/ventas/create">Crear Venta</a>
                <a href="/ventas/update">Actualizar Venta</a>
                <a href="/ventas/delete">Eliminar Venta</a>
            </div>
        </div>
        
        <a href="/historial">Historial</a>
        <a href="/planning">Planificación</a>
        <a href="/informacion_del_proyecto">Información del Proyecto</a>
    </nav>

    {% include 'sidebar.html' %}

    <div class="container">
        <h1>Actualizar Categoría</h1>

        <div id="categorias-list">
            <p>Cargando categorías...</p>
        </div>
    </div>

    <script>
        async function loadCategorias() {
            try {
                // Se asume la ruta de lectura de categorías
                const response = await fetch('/api/categorias');
                const categorias = await response.json();
                const listDiv = document.getElementById('categorias-list');

                if (categorias.length === 0) {
                    listDiv.innerHTML = '<p>No hay categorías disponibles.</p>';
                    return;
                }

                let html = '<table><thead><tr><th>ID</th><th>Nombre</th><th>Código</th><th>Imagen</th><th>Acciones</th></tr></thead><tbody>';
                categorias.forEach(categoria => {
                    html += `<tr>
                        <td>${categoria.id}</td>
                        <td><input type="text" value="${categoria.nombre}" id="nombre-${categoria.id}" required /></td>
                        <td><input type="text" value="${categoria.codigo || ''}" id="codigo-${categoria.id}" /></td>
                        <td>
                            ${categoria.imagen_url ? `<img src="${categoria.imagen_url}" alt="Imagen" style="max-width: 50px; display: block; margin-bottom: 5px;">` : 'N/A'}
                            <input type="file" id="imagen-${categoria.id}" accept="image/*" />
                        </td>
                        <td><button onclick="updateCategoria(${categoria.id})">Actualizar</button></td>
                    </tr>`;
                });
                html += '</tbody></table>';
                listDiv.innerHTML = html;
            } catch (error) {
                document.getElementById('categorias-list').innerHTML = '<p>Error al cargar categorías.</p>';
                console.error('Error:', error);
            }
        }

        async function updateCategoria(id) {
            const nombre = document.getElementById(`nombre-${id}`).value;
            const codigo = document.getElementById(`codigo-${id}`).value;
            const imagenInput = document.getElementById(`imagen-${id}`);
            const formData = new FormData();
            
            // PUT requiere que se pasen todos los campos obligatorios, por lo que es mejor usar PATCH si la API lo permite, pero mantendremos PUT por consistencia con el código original.
            if (!nombre) {
                alert('El nombre de la categoría es obligatorio.');
                return;
            }
            
            formData.append('nombre', nombre);
            if (codigo) formData.append('codigo', codigo);
            if (imagenInput.files[0]) {
                formData.append('imagen', imagenInput.files[0]);
            }
            
            try {
                // Se asume la ruta de actualización de categorías es PUT /api/categorias/{id}
                const response = await fetch(`/api/categorias/${id}`, {
                    method: 'PUT',
                    body: formData
                });

                if (response.ok) {
                    alert('Categoría actualizada exitosamente');
                    loadCategorias(); // Recargar la lista para ver los cambios
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.detail);
                }
            } catch (error) {
                alert('Error de red: ' + error.message);
            }
        }

        window.onload = loadCategorias;
    </script>
</body>
</html>